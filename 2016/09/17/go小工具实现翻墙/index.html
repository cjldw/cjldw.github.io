<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> go小工具实现翻墙 · vvotm</title><meta name="description" content="go小工具实现翻墙 - vvotm(luowen)"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/loovien" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/vvotm" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/me/" target="_self" class="nav-list-link">ABOUTME</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">go小工具实现翻墙</h1><div class="post-info">Sep 17, 2016</div><div class="post-content"><p>最近在学习go, go语言给我最爽的是build后成一个文件, 无需额外的环境以来, 这对发布简直就爽歪歪了。<br>边学边玩的态度, 写了一个go小工具, 基于<a href="http://www.ishadowsocks.org/" target="_blank" rel="external">shawsocks</a>页面实现自动翻墙。</p>
<a id="more"></a>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><ul>
<li><p>go中<code>net/http</code>去获取<code>http://www.ishadowsocks.org/</code>页面内容。</p>
</li>
<li><p>使用<code>regexp</code>包正则匹配主机, 端口, 密码等信息。</p>
</li>
<li><p>构建shadowscoks配置文件结构, 自动写入到gui-config.json文件中。</p>
</li>
<li><p>重启shadowscoks, 是刚写好的gui-config.json生效。</p>
</li>
<li><p>以下是代码部分, 刚学, 多指教, 勿喷。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"io/ioutil"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line">    <span class="string">"net/http"</span></span><br><span class="line">    <span class="string">"os/exec"</span></span><br><span class="line">    <span class="string">"regexp"</span></span><br><span class="line">    <span class="string">"strconv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GuiConfigStruct <span class="keyword">struct</span> &#123; <span class="comment">// 定义gui-config结构</span></span><br><span class="line">    Configs                []ServerItemStruct <span class="string">`json:"configs"`</span></span><br><span class="line">    Strategy               *<span class="keyword">bool</span>              <span class="string">`json:"strategy"`</span></span><br><span class="line">    Index                  <span class="keyword">int</span>                <span class="string">`json:"index"`</span></span><br><span class="line">    Global                 <span class="keyword">bool</span>               <span class="string">`json:"global"`</span></span><br><span class="line">    Enabled                <span class="keyword">bool</span>               <span class="string">`json:"enabled"`</span></span><br><span class="line">    ShareOverLan           <span class="keyword">bool</span>               <span class="string">`json:"shareOverlan"`</span></span><br><span class="line">    IsDefault              <span class="keyword">bool</span>               <span class="string">`json:"isDefault"`</span></span><br><span class="line">    LocalPort              <span class="keyword">int</span>                <span class="string">`json:"localPort"`</span></span><br><span class="line">    PacUrl                 *<span class="keyword">string</span>            <span class="string">`json:"pacUrl"`</span></span><br><span class="line">    UseOnlinePac           <span class="keyword">bool</span>               <span class="string">`json:"useOnlinePac"`</span></span><br><span class="line">    AvailabilityStatistics <span class="keyword">bool</span>               <span class="string">`json:"availabilityStatistics"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ServerItemStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">    Server      <span class="keyword">string</span> <span class="string">`json:"server"`</span></span><br><span class="line">    Server_port <span class="keyword">int</span>    <span class="string">`json:"server_port"`</span></span><br><span class="line">    Password    <span class="keyword">string</span> <span class="string">`json:"password"`</span></span><br><span class="line">    Method      <span class="keyword">string</span> <span class="string">`json:"method"`</span></span><br><span class="line">    Remarks     <span class="keyword">string</span> <span class="string">`json:"remarks"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RemoteHostPortPassword <span class="keyword">struct</span> &#123; <span class="comment">// 匹配远程页面主机, 端口, 密码</span></span><br><span class="line">    Host     <span class="keyword">string</span></span><br><span class="line">    Port     <span class="keyword">int</span></span><br><span class="line">    Password <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SHADOWSOCKS_URL = <span class="string">"http://www.ishadowsocks.org/"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//stopShadowsocks() // 关闭shadowscoks进程, 未成功.. 使用RunHiddenConsole.exe 执行start.bat来关闭</span></span><br><span class="line">    <span class="keyword">var</span> contents <span class="keyword">string</span> = httpGetUrl(SHADOWSOCKS_URL) <span class="comment">// 获取远程页面内容</span></span><br><span class="line">    remoteHostPortPassword := matchHostAndPassword(contents) <span class="comment">// 匹配主机,端口,密码</span></span><br><span class="line">    fmt.Println(remoteHostPortPassword)</span><br><span class="line">    defaultConfig := getGuiConfig() <span class="comment">// 获取gui-config.json结构</span></span><br><span class="line">    rebuildConfig(&amp;remoteHostPortPassword, &amp;defaultConfig) <span class="comment">// 重新赋远程获取的值</span></span><br><span class="line">    jsonBytes, err := json.Marshal(&amp;defaultConfig)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    ioutil.WriteFile(<span class="string">"gui-config.json"</span>, jsonBytes, <span class="number">0777</span>) <span class="comment">// 写入gui-config.json文件</span></span><br><span class="line">    startShadowsocks() <span class="comment">// 启动shadowocks进程</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stopShadowsocks</span><span class="params">()</span></span> &#123;</span><br><span class="line">    command := exec.Command(<span class="string">"taskkill /F /IM shadowsocks.exe"</span>)</span><br><span class="line">    <span class="keyword">if</span> err := command.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startShadowsocks</span><span class="params">()</span></span> &#123;</span><br><span class="line">    command := exec.Command(<span class="string">"cmd"</span>, <span class="string">"/C"</span>, <span class="string">"shadowsocks.exe"</span>)</span><br><span class="line">    <span class="keyword">if</span> err := command.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">rebuildConfig</span><span class="params">(remoteHostPortPassword *RemoteHostPortPassword, guiConfig *GuiConfigStruct)</span></span> &#123;</span><br><span class="line">    guiConfig.Configs[<span class="number">0</span>].Server = remoteHostPortPassword.Host</span><br><span class="line">    guiConfig.Configs[<span class="number">0</span>].Server_port = remoteHostPortPassword.Port</span><br><span class="line">    guiConfig.Configs[<span class="number">0</span>].Password = remoteHostPortPassword.Password</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">httpGetUrl</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    response, error := http.Get(url)</span><br><span class="line">    <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(error)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    contents, error := ioutil.ReadAll(response.Body)</span><br><span class="line">    response.Body.Close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(error)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(contents)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">matchHostAndPassword</span><span class="params">(body <span class="keyword">string</span>)</span> <span class="title">RemoteHostPortPassword</span></span> &#123;</span><br><span class="line">    regexObj := regexp.MustCompile(<span class="string">"C服务器地址:(?P&lt;ip&gt;\\w*\\.\\w*\\.\\w*).*\\n.*端口:(?P&lt;port&gt;\\d*).*\\n.*C密码:(?P&lt;pwd&gt;\\d*)"</span>)</span><br><span class="line">    matchArray := regexObj.FindStringSubmatch(body)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> matchLength <span class="keyword">int</span> = <span class="built_in">len</span>(matchArray)</span><br><span class="line">    resultSet := <span class="built_in">new</span>(RemoteHostPortPassword)</span><br><span class="line">    <span class="keyword">if</span> matchLength == <span class="number">4</span> &#123;</span><br><span class="line">        resultSet.Host = matchArray[<span class="number">1</span>]</span><br><span class="line">        intPort, err := strconv.Atoi(matchArray[<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err)</span><br><span class="line">        &#125;</span><br><span class="line">        resultSet.Port = intPort</span><br><span class="line">        resultSet.Password = matchArray[<span class="number">3</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *resultSet</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getGuiConfig</span><span class="params">()</span> <span class="title">GuiConfigStruct</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">        c, error := ioutil.ReadFile("gui-config.json")</span><br><span class="line"></span><br><span class="line">        if error != nil &#123;</span><br><span class="line">            log.Fatal(error)</span><br><span class="line">        &#125;</span><br><span class="line">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> defaultConfig = GuiConfigStruct&#123;</span><br><span class="line">        Strategy:               <span class="literal">nil</span>,</span><br><span class="line">        Index:                  <span class="number">0</span>,</span><br><span class="line">        Global:                 <span class="literal">false</span>,</span><br><span class="line">        Enabled:                <span class="literal">true</span>,</span><br><span class="line">        ShareOverLan:           <span class="literal">false</span>,</span><br><span class="line">        IsDefault:              <span class="literal">false</span>,</span><br><span class="line">        LocalPort:              <span class="number">1080</span>,</span><br><span class="line">        PacUrl:                 <span class="literal">nil</span>,</span><br><span class="line">        UseOnlinePac:           <span class="literal">false</span>,</span><br><span class="line">        AvailabilityStatistics: <span class="literal">false</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    defaultConfig.Configs = <span class="built_in">make</span>([]ServerItemStruct, <span class="number">1</span>)</span><br><span class="line">    defaultConfig.Configs[<span class="number">0</span>] = ServerItemStruct&#123;</span><br><span class="line">        Server:      <span class="string">"jp3.iss.tf"</span>,</span><br><span class="line">        Server_port: <span class="number">10000</span>,</span><br><span class="line">        Password:    <span class="string">"luowen"</span>,</span><br><span class="line">        Method:      <span class="string">"aes-256-cfb"</span>,</span><br><span class="line">        Remarks:     <span class="string">""</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> defaultConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/09/21/goodbye-可乐/" class="prev">PREV</a><a href="/2016/09/15/mysql主从备份/" class="next">NEXT</a></div><div data-thread-key="2016/09/17/go小工具实现翻墙/" data-title="go小工具实现翻墙" data-url="http://vvotm.github.io/2016/09/17/go小工具实现翻墙/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"superwm"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><div class="copyright"><p>© 2015 - 2016 <a href="http://vvotm.github.io">vvotm(luowen)</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-78479444-1",'auto');ga('send','pageview');</script></body></html>