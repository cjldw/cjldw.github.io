<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Golang 协程下载网站图片资源 · luowen&weiwei-(luowen ❤️ wwei)</title><meta name="description" content="Golang 协程下载网站图片资源 - luowen&lt;loovien@163.com&gt;"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><!--if theme.googlefonts//link(rel="stylesheet", href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type='text/css')--><!--else //link(rel="stylesheet", href="https://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type='text/css')--><meta name="generator" content="Hexo 6.0.0"></head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="http://weibo.com/loovien" target="_blank">WEIBO</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/loovien" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/me/" target="_self">ABOUTME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Golang 协程下载网站图片资源</h1><div class="post-info">May 12, 2017</div><div class="post-content"><p>开始之前, 今天5.12 为我们汶川大地震逝去的人默哀, 愿他们在天堂安好.<br>go语言的协程实战, 爬去网页后, 匹配对应网页上的图片, 对应每个图片开启一个协程去下载. 之前有做对比下载<code>http://www.zhuangbi.info/page=1~72</code>页所有图片, 用php费时2分50多秒, 使用goroutine实现, 费时间7s多点, 这个差距还是挺可观的.</p>
<span id="more"></span>

<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><ul>
<li><code>https://github.com/vvotm/gospider</code></li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ol>
<li><p>可克隆代码go build 安装</p>
</li>
<li><p>或直接下载window版的main.exe直接使用</p>
</li>
<li><p>直接运行<code>main.exe</code>查看帮助</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Uses: main.exe &#123;url&#125; [savepath] [totalPage]</span><br><span class="line"></span><br><span class="line">url: (must) etc. http://www.zhuangbi.info</span><br><span class="line">savepath: (option) the path <span class="built_in">where</span> you want save images</span><br><span class="line">totalPage: (options) only url has page placeholder. <span class="keyword">for</span> example:</span><br><span class="line"></span><br><span class="line">    main.exe http://www.zhuangbi.info/?page=&#123;page&#125; ./tmp 10</span><br><span class="line"></span><br><span class="line">    <span class="built_in">command</span> will download all images from http://www.zhuangbi.info/?page=1 to http://www.zhuangbi.info/?page=10</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><ul>
<li><p>通过命令行的url, 匹配下载对应的网页内容, 做正则匹配到网页的img标签, 获取到图片地址, 在对应开启协程去下载图片保存.</p>
</li>
<li><p>主要代码实现</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">var wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">func Run(url string, path string, page string) &#123;</span><br><span class="line">    regex := regexp.MustCompile(<span class="string">&quot;\\&#123;page\\&#125;&quot;</span>)</span><br><span class="line">    newPage, err := strconv.Atoi(page)</span><br><span class="line">    except.ErrorHandler(err)</span><br><span class="line">    <span class="keyword">if</span> newPage &gt; 0 &amp;&amp; regex.FindAllString(url, -1) != nil &#123;</span><br><span class="line">        <span class="keyword">for</span> i := 1; i &lt;= newPage ; i++  &#123;</span><br><span class="line">            wg.Add(1)</span><br><span class="line">            pageIndex := strconv.Itoa(i)</span><br><span class="line">            newUrl := strings.Replace(url, <span class="string">&quot;&#123;page&#125;&quot;</span>, pageIndex, -1)</span><br><span class="line">            go fetch(newUrl, path)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wg.Add(1)</span><br><span class="line">        go fetch(url, path)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func fetch(url, path string)  &#123;</span><br><span class="line"></span><br><span class="line">    imgname := strconv.Itoa(rand.Int())</span><br><span class="line"></span><br><span class="line">    lastSlashIndex := strings.LastIndex(url, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> lastSlashIndex != -1 &#123;</span><br><span class="line">        imgname = url[lastSlashIndex+1:]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastQutesIndex := strings.LastIndex(imgname, <span class="string">&quot;?&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> lastQutesIndex != -1 &#123;</span><br><span class="line">        imgname = imgname[:lastQutesIndex]</span><br><span class="line">    &#125;</span><br><span class="line">    _, err := os.Stat(path)</span><br><span class="line">    <span class="keyword">if</span> err != nil &amp;&amp; os.IsNotExist(err) &#123;</span><br><span class="line">        os.Mkdir(path, 755)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    content := utils.FetchUrl(url)</span><br><span class="line">    types := []string&#123;<span class="string">&quot;jpg&quot;</span>, <span class="string">&quot;png&quot;</span>, <span class="string">&quot;gif&quot;</span>&#125;</span><br><span class="line">    resultSet := typeMatch.GetImgSlice(content, -1, types)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, url := range(resultSet)  &#123;</span><br><span class="line">        wg.Add(1)</span><br><span class="line">        go downloadImg(url, path)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func downloadImg(url, path string)  &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;download image [&quot;</span> + url + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">    imgStr := utils.FetchUrl(url)</span><br><span class="line">    lastSlashIndex := strings.LastIndex(url, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    filename := strings.Trim(path, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;/&quot;</span> + url[lastSlashIndex+1:]</span><br><span class="line">    fmt.Println(<span class="string">&quot;file:&quot;</span> + filename)</span><br><span class="line">    utils.WriteFile(imgStr, filename)</span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="后期优化"><a href="#后期优化" class="headerlink" title="后期优化"></a>后期优化</h3><ul>
<li>参数优化</li>
<li>正则匹配</li>
<li>panic优化处理</li>
<li>使用channel限制协程数, 目前没有限制</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a class="prev" href="/2017/05/14/centos7%E7%BC%96%E8%AF%91apache2-4-php5-6-mysql5-7/">PREV</a><a class="next" href="/2017/03/26/debian8%E7%BC%96%E8%AF%91nginx%E5%92%8Cphp7/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'superwm';
var disqus_identifier = '2017/05/12/gospider/';
var disqus_title = 'Golang 协程下载网站图片资源';
var disqus_url = 'https://loovien.github.io/2017/05/12/gospider/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2022 <a href="https://loovien.github.io">luowen<loovien@163.com></a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async src="/js/embed.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-78479444-1",'auto');ga('send','pageview');</script></body></html>