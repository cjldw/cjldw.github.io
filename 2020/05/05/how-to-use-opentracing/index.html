<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> how-to-use-opentracing · luowen&weiwei-(luowen ❤️ wwei)</title><meta name="description" content="使用 opentracing 追踪请求"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><!--if theme.googlefonts//link(rel="stylesheet", href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type='text/css')--><!--else //link(rel="stylesheet", href="https://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type='text/css')--><meta name="generator" content="Hexo 6.0.0"></head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="http://weibo.com/loovien" target="_blank">WEIBO</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/loovien" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/me/" target="_self">ABOUTME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">how-to-use-opentracing</h1><div class="post-info">May 5, 2020</div><div class="post-content"><h2 id="golang中使用jaeger实现链路追踪。"><a href="#golang中使用jaeger实现链路追踪。" class="headerlink" title="golang中使用jaeger实现链路追踪。"></a>golang中使用jaeger实现链路追踪。</h2><p>在分布式系统中，问题的定位非常困难，有了jaeger, 一切变的简单了。 举个简单好理解的例子，追踪就像孙悟空(rootSpan)进了盘丝洞,  发现有很多的洞，每个洞都让他的小猴子(childSpan)进入探路，最终所有的猴子探好了路把信息发给一个收集(jaeger-collector), 最后通过jeagerUI查询(jaeger-query)展示</p>
<span id="more"></span>

<ol>
<li>安装jaegertracing/all-in-one</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  --rm   -p 6831:6831/udp   -p 6832:6832/udp   -p 5778:5778   -p 16686:16686   -p 14268:14268   -p 14250:14250   -p 9411:9411   jaegertracing/all-in-one:latest</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建opentracing对象</li>
</ol>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Tracing <span class="keyword">struct</span> &#123;</span><br><span class="line">	opentracing.Tracer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTracing</span><span class="params">()</span> <span class="params">(*Tracing, <span class="keyword">func</span>()</span>, <span class="title">error</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		err    error</span><br><span class="line">		closer io.Closer</span><br><span class="line">		cfg    *config.Configuration</span><br><span class="line">		tracer opentracing.Tracer</span><br><span class="line">	)</span><br><span class="line">	cfg = &amp;config.Configuration&#123;</span><br><span class="line">		Sampler: &amp;config.SamplerConfig&#123;</span><br><span class="line">			Type:  <span class="string">&quot;const&quot;</span>, <span class="comment">// 全量</span></span><br><span class="line">			Param: <span class="number">1</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		Reporter: &amp;config.ReporterConfig&#123;</span><br><span class="line">			LogSpans:           <span class="literal">true</span>,</span><br><span class="line">			LocalAgentHostPort: <span class="string">&quot;192.168.165.21:6831&quot;</span>, <span class="comment">// 运行 all-in-one 的服务IP, </span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	tracer, closer, err = cfg.New(</span><br><span class="line">        <span class="string">&quot;test-tracing&quot;</span>, <span class="comment">// 你的服务名</span></span><br><span class="line">		config.Logger(jaeger.StdLogger), <span class="comment">// 日志, 可以使用自己的logger</span></span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;ERROR: cannot init Jaeger: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	closeFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		_ = closer.Close()</span><br><span class="line">	&#125;</span><br><span class="line">	opentracing.SetGlobalTracer(tracer) <span class="comment">// 设置全局</span></span><br><span class="line">	tracing := &amp;Tracing&#123;</span><br><span class="line">		Tracer:  tracer,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tracing, closeFunc, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">``</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 使用, 一般的 gateway/webhttp 做为追踪的起点， 跟据客户端请求traceid, 服务端接收设置tag标记, 使用gin测试</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`golang </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">func main () &#123;</span></span><br><span class="line"><span class="string">	g := gin.New()</span></span><br><span class="line"><span class="string">	g.GET(&quot;/login&quot;, func(ctx *gin.Context) &#123;</span></span><br><span class="line"><span class="string">		option := opentracing.Tag&#123;Key: &quot;traceId&quot;, Value: ctx.GetHeader(&quot;traceId&quot;)&#125;</span></span><br><span class="line"><span class="string">		span, childctx := opentracing.StartSpanFromContext(ctx, &quot;login&quot;, option) // 设置tag</span></span><br><span class="line"><span class="string">		defer span.Finish()</span></span><br><span class="line"><span class="string">		span.LogKV(&quot;loginRequest&quot;, ctx.Request.UserAgent())</span></span><br><span class="line"><span class="string">		selectdb := func() &#123;</span></span><br><span class="line"><span class="string">			dbspan, _ := opentracing.StartSpanFromContext(childctx, &quot;selectFromDb&quot;) // 从父span派生child span</span></span><br><span class="line"><span class="string">			defer dbspan.Finish()</span></span><br><span class="line"><span class="string">			dbspan.LogKV(&quot;selectFromDb&quot;, &quot;id:100&quot;)</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">		selectdb()</span></span><br><span class="line"><span class="string">        c.JSON(200, gin.H(&#123;&quot;message&quot;: &quot;ok&quot;&#125;))</span></span><br><span class="line"><span class="string">	&#125;)</span></span><br><span class="line"><span class="string">	g.Run(&quot;:8080&quot;)</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>访问<a target="_blank" rel="noopener" href="http://localhost:8080/login">http://localhost:8080/login</a> 后再去jaegerUI查看 <a target="_blank" rel="noopener" href="http://192.168.165.21:16686/">http://192.168.165.21:16686/</a>, 能看到记录的span。</li>
</ol>
<p>PS: 这个tracing个入感觉对代码的侵入很大。可以针对有必要的进行追踪.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/yurishkuro/opentracing-tutorial">更好的学习资料</a></p>
</div></article></div></section><footer><div class="paginator"><a class="prev" href="/2020/08/21/%E4%BD%BF%E7%94%A8selenium+chrome%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E5%AD%A6%E4%B9%A0%E5%BC%BA%E5%9B%BD/">PREV</a><a class="next" href="/2020/02/10/iNodevpn/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'superwm';
var disqus_identifier = '2020/05/05/how-to-use-opentracing/';
var disqus_title = 'how-to-use-opentracing';
var disqus_url = 'https://loovien.github.io/2020/05/05/how-to-use-opentracing/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2022 <a href="https://loovien.github.io">luowen<loovien@163.com></a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async src="/js/embed.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-78479444-1",'auto');ga('send','pageview');</script></body></html>