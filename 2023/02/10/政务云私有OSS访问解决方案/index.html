<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 政务云私有OSS解决方案 · luowen&weiwei-(luowen ❤️ wwei)</title><meta name="description" content="政务云私有OSS解决方案"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><!--if theme.googlefonts//link(rel="stylesheet", href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type='text/css')--><!--else //link(rel="stylesheet", href="https://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type='text/css')--><meta name="generator" content="Hexo 6.3.0"></head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="http://weibo.com/loovien" target="_blank">WEIBO</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/loovien" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/me/" target="_self">ABOUTME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">政务云私有OSS解决方案</h1><div class="post-info">Feb 10, 2023</div><div class="post-content"><p>政务云OSS为了安全考虑，BUCKET一股脑全部要求私有。这样直接导致了一些公开的资源被迫做鉴权处理了。然后分析业务，其实多此一举。<br>我理解的私有OSS只是对一些敏感的资源做存储，然后针对用户权限做开放处理，比如只有用于权限的用户，才能获取OSS的AccessKey, AccessSecret,生成图片签名,<br>预览下载资源文件。也就是说，业务上分2个BUCKET, 公开的传共有读OOS, 敏感的传私有OSS, 而不是以安全为理由，全部私有化。</p>
<span id="more"></span>

<p>得知这个消息，心中几万只cnm, 然而事情还是的做。应为已经有了历史文件，想到的办法就是通过nginx匹配路径做方向代理处理。</p>
<p>方案1： NGINX匹配上路径后，转发到后端的服务，有后端的服务生成代签名的URL, 并返回302做重定向。<br>方案2： NGINX匹配上路径后，转发到后端的服务，有后端的服务生成代签名的URL, 并获取内容，直接返回前端资源文件流。<br>方案3： NGINX匹配上路径后, 通过NGINX的LUA脚本实现签名生成，添加头，并方向代理到私有OSS地址。</p>
<p>综合考虑开发成本，选用第三种方案，对历史文件，新有的业务没有任何影响。方案1，2需要多出一个服务来。</p>
<p>代码如下简单搞定：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">location</span> <span class="regexp">~* ^/assets</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> = <span class="string">&#x27;OPTIONS&#x27;</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">204</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">set_by_lua_block</span> <span class="variable">$gmt_time</span> &#123;</span><br><span class="line">        <span class="attribute">local</span> time = os.time() - <span class="number">8</span> * <span class="number">3600</span></span><br><span class="line">        return os.date(<span class="string">&quot;%a, %d %b %Y %X GMT&quot;</span>, time)</span><br><span class="line">    &#125;</span><br><span class="line">    set_by_lua_block <span class="variable">$signature</span> &#123;</span><br><span class="line">        <span class="attribute">local</span> accessKeyId = <span class="string">&quot;KEYID&quot;</span></span><br><span class="line">        local accessKeySecret = <span class="string">&quot;SECRET&quot;</span></span><br><span class="line">        local bucket = <span class="string">&quot;BUCKET&quot;</span></span><br><span class="line">        local data = string.format(<span class="string">&quot;%s\n\n\n%s\n/%s%s&quot;</span>, ngx.req.get_method(), ngx.var.gmt_time, bucket, ngx.var.uri)</span><br><span class="line">        local signature = ngx.encode_base64(ngx.hmac_sha1(accessKeySecret, data))</span><br><span class="line">        return string.format(<span class="string">&quot;OSS %s:%s&quot;</span>, accessKeyId, signature)</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_set_header Date <span class="variable">$gmt_time</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Authorization <span class="variable">$signature</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://private-oss.internat.net;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>PS: 已经很长一段时间没有输出了，佛系更 :)</p>
</div></article></div></section><footer><div class="paginator"><a class="next" href="/2022/01/14/%E6%88%91%E7%9A%84%E5%85%A8%E6%96%B0%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'superwm';
var disqus_identifier = '2023/02/10/政务云私有OSS访问解决方案/';
var disqus_title = '政务云私有OSS解决方案';
var disqus_url = 'https://loovien.github.io/2023/02/10/政务云私有OSS访问解决方案/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2023 <a href="https://loovien.github.io">luowen<loovien@163.com></a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async src="/js/embed.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-78479444-1",'auto');ga('send','pageview');</script></body></html>