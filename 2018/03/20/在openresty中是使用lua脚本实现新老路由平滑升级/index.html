<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 在openresty中是使用lua脚本实现新老路由平滑升级 · luowen&weiwei-(luowen ❤️ wwei)</title><meta name="description" content="在openresty中是使用lua脚本实现新老路由平滑升级"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><!--if theme.googlefonts//link(rel="stylesheet", href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type='text/css')--><!--else //link(rel="stylesheet", href="https://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type='text/css')--><meta name="generator" content="Hexo 6.0.0"></head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="http://weibo.com/loovien" target="_blank">WEIBO</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/loovien" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="/me/" target="_self">ABOUTME</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">在openresty中是使用lua脚本实现新老路由平滑升级</h1><div class="post-info">Mar 20, 2018</div><div class="post-content"><p>想升级PHP框架phalcon到3.x, 但是发现升级后与老版本基本不兼容, 也就意味着代码基本要重写了。考虑到不可能一下把所有的接口切换到新的框架上去（不能短时间内全部迁移所有的接口，新的框架提供的接口需要测试时间）。想到的方案是， 一方面提供新的接口使用新的框架编写，然后网关判断， 如果是新的接口就路由到新的框架部署的服务器上。空闲的时间，慢慢的把老的接口往新的框架上迁移。一下简单的实现了一个demo案列。</p>
<span id="more"></span>

<p><strong>环境以及依赖软件</strong></p>
<ul>
<li>window 10。</li>
<li>openresty/1.13.6.1 提供网关服务。</li>
<li>redis-server 提供新路由存储。</li>
<li>golang 模拟提供web服务。</li>
</ul>
<p>这里不对<a target="_blank" rel="noopener" href="http://openresty.org/">openresty</a>, <a target="_blank" rel="noopener" href="https://golang.org/">golang</a>做介绍了。</p>
<p><strong>openresty配置</strong></p>
<p>编辑<code>nginx.conf</code>文件, 默认使用<code>phalcon1</code>upstream,当<code>rewrite_by_lua_file</code>执行完后, 如果是新的路由, 会重写<code>phalcon1</code>到<code>phalcon3</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">upstream phalcon1 &#123;</span><br><span class="line">    server 127.0.0.1:8088 fail_timeout=53 weight=4 max_fails=100;</span><br><span class="line">&#125;</span><br><span class="line">upstream phalcon3 &#123;</span><br><span class="line">    server 127.0.0.1:8089 fail_timeout=53 weight=10 max_fails=100;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    #charset koi8-r;</span><br><span class="line">    access_log  logs/host.access.log  main;</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    location /api/user &#123;</span><br><span class="line">        default_type text/html;</span><br><span class="line">        set $upstream &quot;phalcon1&quot;;</span><br><span class="line">        # set_by_lua_file $upstream &quot;lualib/zq/chrbyuri.lua&quot;; # set_by_lua_file 关闭了 resty_redis API</span><br><span class="line">        rewrite_by_lua_file &quot;lualib/zq/chrbyuri.lua&quot;;</span><br><span class="line">        proxy_pass http://$upstream;</span><br><span class="line">    &#125;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>chrbyuri.lua</strong></p>
<p>从redis中查找是否是新的路由, 新的话重写<code>phalcon1</code>到<code>phalcon3</code>, 这里有个小规则, 框架中有的路由是 <code>/api/user/&#123;page&#125;/&#123;num&#125;.json</code> 由于这些路由是动态, 不好固化存在redis中, 这列只做了简单的处理, 就是替换成 <code>&#123;num&#125;</code>, 比如请求路由: <code>/api/user/100/10/post.json</code> =&gt; <code>/api/user/&#123;num&#125;/&#123;num&#125;/post.json</code>, 对应的在redis存替换的key就好了。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> newupstream = <span class="string">&quot;phalcon3&quot;</span></span><br><span class="line"><span class="keyword">local</span> redis_host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="keyword">local</span> redis_port = <span class="number">6379</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">&quot;resty.redis&quot;</span></span><br><span class="line"><span class="keyword">local</span> uri = ngx.var.uri</span><br><span class="line"><span class="keyword">local</span> r = uri:<span class="built_in">gsub</span>(<span class="string">&quot;/%d+&quot;</span>, <span class="string">&quot;/&#123;num&#125;&quot;</span>)</span><br><span class="line">ngx.<span class="built_in">log</span>(ngx.INFO, <span class="string">&quot;origin document_uri:&quot;</span>, uri)</span><br><span class="line">ngx.<span class="built_in">log</span>(ngx.INFO, <span class="string">&quot;replace document_uri:&quot;</span>, r)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- connect redis server</span></span><br><span class="line"><span class="keyword">local</span> route_redis = redis:new()</span><br><span class="line"><span class="keyword">local</span> ok, err = route_redis:connect(redis_host, redis_port)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&quot;connect to redis error&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- query document_uri is exists or not</span></span><br><span class="line"><span class="keyword">local</span> newsrv, err = route_redis:get(r)</span><br><span class="line"><span class="keyword">if</span> newsrv == ngx.null <span class="keyword">then</span></span><br><span class="line">  ngx.<span class="built_in">log</span>(ngx.INFO, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;route %s is not new route&quot;</span>, r))</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- override upstream</span></span><br><span class="line">ngx.var.upstream = newupstream</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>golang实现的web服务</strong></p>
<p>端口8088为老的接口服务器，提供 <code>/api/user/user.info1</code> <code>/api/user/user.info2</code> 2个接口。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># filename: phalcon1.<span class="keyword">go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/api/user/user.info1&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		rw.Write([]<span class="keyword">byte</span>(<span class="string">&quot;phalcon1:8088 handle route: &#123;api/user/user.info2&#125;&quot;</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/api/user/user.info2&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		rw.Write([]<span class="keyword">byte</span>(<span class="string">&quot;phalcon1:8088 handle route: &#123;api/user/user.info2&#125;&quot;</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">	log.Fatalf(<span class="string">&quot;server exception: %+v \n&quot;</span>, http.ListenAndServe(<span class="string">&quot;:8088&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>端口8089为新的接口服务器，提供 <code>/api/user/user.info3</code> 1个接口。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"># filename: phalcon3.<span class="keyword">go</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/api/user/user.info3&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		rw.Write([]<span class="keyword">byte</span>(<span class="string">&quot;phalcon1:8089 handle route: &#123;api/user/user.info2&#125;&quot;</span>))</span><br><span class="line">	&#125;)</span><br><span class="line">	log.Fatalf(<span class="string">&quot;server exception: %+v \n&quot;</span>, http.ListenAndServe(<span class="string">&quot;:8089&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<ol>
<li><p>启动openresty <code>cd /path/to/openresty/nginx.exe</code>。</p>
</li>
<li><p>启动redis-server <code>cd /path/to/redis-server/redis-server -c /path/to/redis-server.conf</code>。</p>
</li>
<li><p>启动phalcon2 <code>go run phalcon3.go</code>。</p>
</li>
<li><p>启动phalcon1 <code>go run phalcon1.go</code>。</p>
</li>
<li><p>将新的路由写入到redis中 <code>redis-cli set /api/user/user.info3 1</code>。</p>
</li>
<li><p>访问 <code>http://localhost/api/user/user.info1</code>  <code>http://localhost/api/user/user.info2</code> 还是代理到了phalcon1上。</p>
</li>
<li><p>访问 <code>http://localhost/api/user/user.info3</code> 就代理到了phalcon3上了。</p>
</li>
</ol>
<p><strong>后续</strong></p>
<p>当有新的接口发布时候, 记得往redis写入新的路由标识即可了。</p>
</div></article></div></section><footer><div class="paginator"><a class="prev" href="/2018/04/01/%E7%BC%96%E8%AF%91php%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E9%9B%86%E5%90%88/">PREV</a><a class="next" href="/2018/03/17/%E6%89%B9%E9%87%8F%E6%9F%A5%E8%AF%A2%E7%94%B5%E8%AF%9D%E5%BD%92%E5%B1%9E%E5%9C%B0/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'superwm';
var disqus_identifier = '2018/03/20/在openresty中是使用lua脚本实现新老路由平滑升级/';
var disqus_title = '在openresty中是使用lua脚本实现新老路由平滑升级';
var disqus_url = 'https://loovien.github.io/2018/03/20/在openresty中是使用lua脚本实现新老路由平滑升级/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2022 <a href="https://loovien.github.io">luowen<loovien@163.com></a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script async src="/js/embed.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-78479444-1",'auto');ga('send','pageview');</script></body></html>